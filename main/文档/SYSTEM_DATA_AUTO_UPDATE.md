# ç³»ç»Ÿåº•å±‚æ•°æ®è‡ªåŠ¨æ›´æ–°æœºåˆ¶

## æ¦‚è¿°

ç³»ç»Ÿåº•å±‚æ•°æ®ï¼ˆå¦‚ç”µæ± ç”µå‹ï¼‰åº”è¯¥åœ¨UIåˆ·æ–°æ—¶è‡ªåŠ¨è·å–æœ€æ–°å€¼ï¼Œè€Œä¸æ˜¯ä¾èµ–åº”ç”¨å±‚æ‰‹åŠ¨æ›´æ–°ã€‚

## å®ç°åŸç†

### ä¿®å¤å‰çš„é—®é¢˜

```c
// åˆå§‹åŒ–æ—¶ï¼ˆä»…ä¸€æ¬¡ï¼‰
void smart_ui_data_init(void) {
    g_system_data.power_voltage = BAT_Get_Volts();  // â† åªè°ƒç”¨ä¸€æ¬¡ï¼
    g_system_data.power_valid = 1;
}

// åˆ·æ–°UIæ—¶
static void refresh_all_ui_elements(void) {
    const smart_ui_system_data_t *system_data = smart_ui_get_system_data();
    // æ˜¾ç¤ºçš„æ˜¯åˆå§‹åŒ–æ—¶çš„æ—§å€¼ âŒ
    snprintf(buf, "ç”µæº: %.2fV", system_data->power_voltage);
}
```

**é—®é¢˜ï¼š** ç”µå‹å€¼æ°¸è¿œæ˜¯ç¨‹åºå¯åŠ¨æ—¶çš„å€¼ï¼Œä¸ä¼šéšç”µæ± å……æ”¾ç”µå˜åŒ–ï¼

### ä¿®å¤åçš„å®ç°

```c
static void refresh_all_ui_elements(void)
{
    /* 1. å®æ—¶è·å–åº•å±‚ç³»ç»Ÿæ•°æ® */
    float current_voltage = BAT_Get_Volts();  // â† æ¯æ¬¡åˆ·æ–°éƒ½è°ƒç”¨ï¼
    
    /* 2. æ›´æ–°æ•°æ®å±‚ç¼“å­˜ */
    g_system_data.power_voltage = current_voltage;
    g_system_data.power_valid = 1;
    
    /* 3. æ›´æ–°UIæ˜¾ç¤º */
    if (system_power_label) {
        snprintf(buf, sizeof(buf), "ç”µæº: %.2fV", current_voltage);
        lv_label_set_text(system_power_label, buf);
    }
}
```

**æ”¹è¿›ï¼š**
- âœ… æ¯500msè‡ªåŠ¨è¯»å–æœ€æ–°ç”µå‹
- âœ… æ•°æ®å±‚å’ŒUIæ˜¾ç¤ºéƒ½æ˜¯æœ€æ–°å€¼
- âœ… æ— éœ€åº”ç”¨å±‚æ‰‹åŠ¨æ›´æ–°

## æ•°æ®æ›´æ–°æµç¨‹

### å®Œæ•´æ›´æ–°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®šæ—¶å™¨ (æ¯500ms)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  smart_ui_tick_cb()                     â”‚
â”‚    â””â”€> refresh_all_ui_elements()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è¯»å–åº•å±‚ç¡¬ä»¶                         â”‚
â”‚     current_voltage = BAT_Get_Volts()   â”‚
â”‚                                         â”‚
â”‚  2. æ›´æ–°æ•°æ®å±‚                           â”‚
â”‚     g_system_data.power_voltage = ...   â”‚
â”‚                                         â”‚
â”‚  3. æ›´æ–°UIæ˜¾ç¤º                           â”‚
â”‚     lv_label_set_text("ç”µæº: 4.15V")    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é€‚åˆè‡ªåŠ¨æ›´æ–°çš„æ•°æ®ç±»å‹

### âœ… åº”è¯¥è‡ªåŠ¨æ›´æ–°çš„

1. **ç”µæ± ç”µå‹**
   - éšæ—¶é—´å˜åŒ–
   - ç³»ç»Ÿåº•å±‚æ•°æ®
   - é€šè¿‡ `BAT_Get_Volts()` è·å–

2. **WiFi RSSIï¼ˆå¦‚æœéœ€è¦ï¼‰**
   - ä¿¡å·å¼ºåº¦å®æ—¶å˜åŒ–
   - å¯é€šè¿‡ WiFi API è·å–
   ```c
   wifi_ap_record_t ap_info;
   if (esp_wifi_sta_get_ap_info(&ap_info) == ESP_OK) {
       int8_t rssi = ap_info.rssi;
   }
   ```

3. **ç³»ç»Ÿè¿è¡Œæ—¶é—´**
   - è‡ªåŠ¨é€’å¢
   - å¯é€šè¿‡ `esp_timer_get_time()` è·å–

### âŒ ä¸åº”è¯¥è‡ªåŠ¨æ›´æ–°çš„

1. **ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆæ¸©åº¦ã€æ¹¿åº¦ç­‰ï¼‰**
   - éœ€è¦åº”ç”¨å±‚é€»è¾‘å¤„ç†
   - å¯èƒ½éœ€è¦æ»¤æ³¢ã€æ ¡å‡†
   - åº”è¯¥ç”±åº”ç”¨å±‚è°ƒç”¨ `ui_update_environment()`

2. **æˆ¿é—´è®¾å¤‡çŠ¶æ€**
   - éœ€è¦ç½‘ç»œé€šä¿¡è·å–
   - æœ‰ä¸šåŠ¡é€»è¾‘
   - åº”è¯¥ç”±è®¾å¤‡ç®¡ç†ä»»åŠ¡è°ƒç”¨ `ui_update_room()`

3. **èƒ½è€—æ•°æ®**
   - éœ€è¦ç´¯åŠ è®¡ç®—
   - æœ‰ä¸šåŠ¡é€»è¾‘
   - åº”è¯¥ç”±èƒ½è€—ç›‘æ§ä»»åŠ¡è°ƒç”¨ `ui_update_energy()`

## æ‰©å±•ï¼šæ·»åŠ æ›´å¤šè‡ªåŠ¨æ›´æ–°é¡¹

### ç¤ºä¾‹ï¼šæ·»åŠ WiFi RSSIè‡ªåŠ¨æ›´æ–°

```c
#include "esp_wifi.h"

static void refresh_all_ui_elements(void)
{
    char buf[128];
    
    /* å®æ—¶è·å–åº•å±‚ç³»ç»Ÿæ•°æ® */
    float current_voltage = BAT_Get_Volts();
    g_system_data.power_voltage = current_voltage;
    g_system_data.power_valid = 1;
    
    /* å®æ—¶è·å–WiFiä¿¡å·å¼ºåº¦ */
    wifi_ap_record_t ap_info;
    if (esp_wifi_sta_get_ap_info(&ap_info) == ESP_OK) {
        g_system_data.wifi_rssi = ap_info.rssi;
        strncpy(g_system_data.wifi_status, (char*)ap_info.ssid, 
                sizeof(g_system_data.wifi_status) - 1);
        g_system_data.wifi_valid = 1;
    } else {
        strncpy(g_system_data.wifi_status, "æœªè¿æ¥", 
                sizeof(g_system_data.wifi_status) - 1);
        g_system_data.wifi_valid = 1;
    }
    
    /* æ›´æ–°UI... */
}
```

### ç¤ºä¾‹ï¼šæ·»åŠ ç³»ç»Ÿè¿è¡Œæ—¶é—´æ˜¾ç¤º

```c
static void refresh_all_ui_elements(void)
{
    /* è·å–ç³»ç»Ÿè¿è¡Œæ—¶é—´ */
    int64_t uptime_us = esp_timer_get_time();
    uint32_t uptime_sec = uptime_us / 1000000;
    uint32_t hours = uptime_sec / 3600;
    uint32_t minutes = (uptime_sec % 3600) / 60;
    
    if (system_uptime_label) {
        snprintf(buf, sizeof(buf), "è¿è¡Œæ—¶é—´: %uh %um", hours, minutes);
        lv_label_set_text(system_uptime_label, buf);
    }
}
```

## æ€§èƒ½è€ƒè™‘

### ADCè¯»å–æ€§èƒ½

`BAT_Get_Volts()` å†…éƒ¨è°ƒç”¨ADCè¯»å–ï¼š
- å•æ¬¡ADCè¯»å–ï¼šçº¦ 10-20 å¾®ç§’
- å¯¹500mså®šæ—¶å™¨å½±å“ï¼š**å¯å¿½ç•¥ä¸è®¡**

### WiFi APIæ€§èƒ½

`esp_wifi_sta_get_ap_info()` åªæ˜¯è¯»å–ç¼“å­˜ï¼š
- æ‰§è¡Œæ—¶é—´ï¼šçº¦ 1-5 å¾®ç§’
- ä¸ä¼šè§¦å‘å®é™…çš„WiFiæ‰«æ

### å»ºè®®çš„åˆ·æ–°é¢‘ç‡

| æ•°æ®ç±»å‹ | æ¨èåˆ·æ–°é—´éš” | è¯´æ˜ |
|---------|-------------|------|
| ç”µæ± ç”µå‹ | 500ms - 1s | å˜åŒ–ç¼“æ…¢ï¼Œ0.5ç§’è¶³å¤Ÿ |
| WiFi RSSI | 1s - 2s | å®æ—¶æ€§è¦æ±‚ä¸é«˜ |
| è¿è¡Œæ—¶é—´ | 1s | ç§’çº§ç²¾åº¦ |
| æ¸©åº¦ | 5s - 10s | ç”±åº”ç”¨å±‚æ§åˆ¶ |
| è®¾å¤‡çŠ¶æ€ | 2s - 5s | ç”±åº”ç”¨å±‚æ§åˆ¶ |

## è°ƒè¯•éªŒè¯

### éªŒè¯ç”µå‹è‡ªåŠ¨æ›´æ–°

1. **ç¼–è¯‘å¹¶çƒ§å½•ç¨‹åº**
2. **è§‚å¯Ÿä¸²å£è¾“å‡º**ï¼ˆå¦‚æœæ·»åŠ äº†æ—¥å¿—ï¼‰
3. **åœ¨UIä¸Šè§‚å¯Ÿç”µå‹å€¼**
   - å¦‚æœè¿æ¥å……ç”µå™¨ï¼Œç”µå‹åº”è¯¥é€æ¸ä¸Šå‡
   - å¦‚æœæ‹”æ‰å……ç”µå™¨ï¼Œç”µå‹åº”è¯¥é€æ¸ä¸‹é™

### æ·»åŠ è°ƒè¯•æ—¥å¿—

```c
#include "esp_log.h"
static const char *TAG = "UI_REFRESH";

static void refresh_all_ui_elements(void)
{
    /* å®æ—¶è·å–åº•å±‚ç³»ç»Ÿæ•°æ® */
    float current_voltage = BAT_Get_Volts();
    ESP_LOGI(TAG, "Battery voltage: %.2fV", current_voltage);  // â† è°ƒè¯•æ—¥å¿—
    
    g_system_data.power_voltage = current_voltage;
    g_system_data.power_valid = 1;
    
    // ...
}
```

åœ¨ä¸²å£ç›‘è§†å™¨ä¸­åº”è¯¥çœ‹åˆ°ï¼š
```
I (1234) UI_REFRESH: Battery voltage: 4.15V
I (1734) UI_REFRESH: Battery voltage: 4.15V
I (2234) UI_REFRESH: Battery voltage: 4.16V  â† ç”µå‹å˜åŒ–
I (2734) UI_REFRESH: Battery voltage: 4.16V
```

## æ€»ç»“

### è®¾è®¡åŸåˆ™

1. **åº•å±‚ç³»ç»Ÿæ•°æ®** â†’ è‡ªåŠ¨æ›´æ–°ï¼ˆåœ¨UIåˆ·æ–°æ—¶è¯»å–ï¼‰
   - ç”µæ± ç”µå‹ã€WiFi RSSIã€ç³»ç»Ÿæ—¶é—´ç­‰

2. **åº”ç”¨å±‚ä¸šåŠ¡æ•°æ®** â†’ æ‰‹åŠ¨æ›´æ–°ï¼ˆé€šè¿‡ `ui_update_xxx()`ï¼‰
   - ä¼ æ„Ÿå™¨æ•°æ®ã€è®¾å¤‡çŠ¶æ€ã€èƒ½è€—æ•°æ®ç­‰

### ä¼˜åŠ¿

- âœ… åº•å±‚æ•°æ®å®æ—¶å‡†ç¡®
- âœ… æ— éœ€åº”ç”¨å±‚å…³å¿ƒ
- âœ… ç®€åŒ–åº”ç”¨å±‚ä»£ç 
- âœ… æ€§èƒ½å½±å“å¯å¿½ç•¥

### æƒè¡¡

- âš ï¸ å¢åŠ å°‘é‡CPUå¼€é”€ï¼ˆæ¯500mså‡ åå¾®ç§’ï¼‰
- âš ï¸ ä¸é€‚åˆéœ€è¦å¤æ‚å¤„ç†çš„æ•°æ®
- âš ï¸ ä¸é€‚åˆéœ€è¦ç½‘ç»œé€šä¿¡çš„æ•°æ®

### å½“å‰å®ç°

**å·²è‡ªåŠ¨æ›´æ–°ï¼š**
- âœ… ç”µæ± ç”µå‹ï¼ˆæ¯500msï¼‰

**éœ€æ‰‹åŠ¨æ›´æ–°ï¼š**
- ğŸ“ æ¸©åº¦/æ¹¿åº¦ â†’ `ui_update_environment()`
- ğŸ“ WiFiçŠ¶æ€ â†’ `ui_update_system()`
- ğŸ“ æˆ¿é—´è®¾å¤‡ â†’ `ui_update_room()`
- ğŸ“ èƒ½è€—æ•°æ® â†’ `ui_update_energy()`
- ğŸ“ å®‰é˜²çŠ¶æ€ â†’ `ui_update_security()`
